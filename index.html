<script src="https://unpkg.com/@tensorflow/tfjs"></script>
<script src="https://unpkg.com/@tensorflow/tfjs-automl"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.26/webcam.min.js"></script>
<body>
  <div>
    <button onclick="init()">Evaluate Live WebCam</button>
    <button onclick="stop()">Stop Evaluating</button> <br/>
  </div>
  <div style="display:block">
    <div style="float:left">
      <div id="cam" style="position:absolute"></div>
      <canvas id="draw" width="640" height="480" style="position:absolute; border:2px solid black;"></canvas>
    </div>
    <div id="prediction" style="float:right; font-size:32px"></div>
  <div>

</body>
<script>
Webcam.set({
  width:        640,
  height:       480,
  image_format: 'jpeg',
  jpeg_quality: '40'
})
Webcam.attach('#cam')

const img = document.createElement('img');
const pre = document.getElementById('prediction');
const c = document.getElementById("draw");
const ctx = c.getContext("2d");
ctx.lineWidth = 4;
ctx.font = "30px Verdana";


var model;
var preLastPredictions;
var lastPredictions;
var count = 0;

var pollingId = null;
function init() {
  tf.automl.loadObjectDetection('model.json').then(mdl => {
    model = mdl;
  }).catch((x) => console.log("Error of this shit")).then(() => {
    pollingId = setInterval(() => {
      Webcam.snap(function run(data_uri) {
          img.src = data_uri;
          model.detect(img, {
            score:  0.4, //Tune this pls :(
            iou:    0.5,
            topk:   20
          }).then((predictions) => {
              if (predictions[0]) {
                pre.innerText = JSON.stringify(predictions, null, 10);
                if (count < 5) count++;
                ctx.clearRect(0, 0, c.width, c.height);
                preLastPredictions = lastPredictions;
                lastPredictions = predictions;
                predictions.forEach(obj => {
                  let gradient = ctx.createLinearGradient(0, 0, c.width, 0);
                  gradient.addColorStop("1.0", obj.label == "mask" ? "lightgreen" : "red");
                  ctx.strokeStyle = gradient;
                  ctx.strokeText(obj.label == "mask" ? "Mask" : "Not Mask", obj.box.left - 8, obj.box.top - 4);
                  ctx.strokeText((obj.score * 100).toFixed(2) + "%", obj.box.left + obj.box.width * 0.75 , obj.box.top - 4);
                  ctx.strokeRect(obj.box.left, obj.box.top, obj.box.width, obj.box.height);
                });
              } else {
                pre.innerText = "Loading...";
                if (count) {
                  count--;
                  ctx.clearRect(0, 0, c.width, c.height);
                  lastPredictions.forEach((obj, idx) => {
                    let gradient = ctx.createLinearGradient(0, 0, c.width, 0);
                    gradient.addColorStop("1.0", obj.label == "mask" ? "lightgreen" : "red");
                    ctx.strokeStyle = gradient;

                    let compensatedLeft = obj.box.left + ((obj.box.left - preLastPredictions[idx].box.left)/2);
                    let compensatedTop = obj.box.top + ((obj.box.top - preLastPredictions[idx].box.top)/2);

                    ctx.strokeText(obj.label == "mask" ? "Mask C." : "Not Mask C.", compensatedLeft - 8, compensatedTop - 4);
                    ctx.strokeText((obj.score * 100).toFixed(2) + "%", compensatedLeft + obj.box.width * 0.75 , compensatedTop - 4);
                    ctx.strokeRect(compensatedLeft, compensatedTop, obj.box.width, obj.box.height);
                  });
                } else setTimeout(() => { ctx.clearRect(0, 0, c.width, c.height); }, 1500);
              }
          }).catch((x) => {
            pre.innerText = "Loading...";
          });
      });
    }, 200);
  });
};
function stop() {
  clearInterval(pollingId);
  ctx.clearRect(0, 0, c.width, c.height);
};
</script>
