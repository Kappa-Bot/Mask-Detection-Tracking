<script src="https://unpkg.com/@tensorflow/tfjs"></script>
<script src="https://unpkg.com/@tensorflow/tfjs-automl"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.26/webcam.min.js"></script>
<body>
  <div>
    <button onclick="init()">Evaluate Live WebCam</button>
    <button onclick="stop()">Stop Evaluating</button> <br/>
    <div id="result" style="display:block"></div>
    <div id="prediction" style="display:inline-block"></div>
  </div>
  <div>
    <div id="cam" style="position:absolute"></div>
    <canvas id="draw" width="640" height="480" style="position:absolute; border:2px solid black;"></canvas>
  </div>

</body>
<script>
Webcam.set({
  width:        640,
  height:       480,
  image_format: 'jpeg',
  jpeg_quality: '40'
})
Webcam.attach('#cam')

const img = document.createElement('img');
const pre = document.getElementById('prediction');
const c = document.getElementById("draw");
const ctx = c.getContext("2d");
ctx.lineWidth = 4;
ctx.font = "28px Comic Sans MS red";
ctx.fillStyle = "red";


var model;
function run(data_uri) {
    img.src = data_uri;
    ctx.clearRect(0, 0, c.width, c.height);
    model.detect(img, {
      score:  0.3, //Tune this pls :(
      iou:    0.5,
      topk:   20
    }).then((predictions) => {
      pre.innerText = JSON.stringify(predictions, null, 10);
      predictions.forEach(obj => {
        let gradient = ctx.createLinearGradient(0, 0, c.width, 0);
        gradient.addColorStop("1.0", obj.label == "mask" ? "green" : "red");
        ctx.strokeStyle = gradient;
        ctx.strokeText(obj.label, obj.box.left + 4, obj.box.top - 4);
        ctx.strokeText((obj.score * 100).toFixed(2) + "%", obj.box.left + obj.box.width * 0.67 , obj.box.top - 4);
        ctx.strokeRect(obj.box.left, obj.box.top, obj.box.width, obj.box.height);
      });
    });
};

var pollingId = null;
async function init() {
  tf.automl.loadObjectDetection('model.json').then(mdl => {
    model = mdl;
  }).then(() => {
    pollingId = setInterval(() => {
      Webcam.snap(run);
    }, 200);
  });
};
function stop() { clearInterval(pollingId); };
</script>
